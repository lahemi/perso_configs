#!/usr/bin/env lua
-- I use fetchmail to get local copies of my mail.
-- Unfortunately, there was some issues with the encoding,
-- so here be a utf-8 and iso-8859-1 converter.
-- GPLv3, 2013, Lauri Peltomäki
--
-- Usage: ./script /path/to/mail

local filereadall = function(file)
    local ret = ""
    if not file then -- Magicks of empty if body.
    else
        local fh = io.open(file)
        if not fh then 
            ret = "File handle not handled!"
        else
            ret = fh:read('*a')
            fh:close()
        end
        return ret
    end
end

local mail = filereadall(arg[1])

local utf8tbl = {
    ["=09"] = "    ", ["=0A"] = "\n", ["=0D"] = "\r", ["=20"] = " ",
    ["=21"] = "!", ["=22"] = '"', ["=23"] = "#", ["=24"] = "$", ["=25"] = "%",
    ["=26"] = "&", ["=27"] = "'", ["=28"] = "(", ["=29"] = ")", ["=2a"] = "*",
    ["=2b"] = "+", ["=2c"] = ",", ["=2d"] = "-", ["=2e"] = ".", ["=2f"] = "/",
    ["=30"] = "0", ["=31"] = "1", ["=32"] = "2", ["=33"] = "3", ["=34"] = "4",
    ["=35"] = "5", ["=36"] = "6", ["=37"] = "7", ["=38"] = "8", ["=39"] = "9",
    ["=3a"] = ":", ["=3b"] = ";", ["=3c"] = "<", ["=3d"] = "=", ["=3e"] = ">",
    ["=3f"] = "?", ["=40"] = "@", ["=41"] = "A", ["=42"] = "B", ["=43"] = "C",
    ["=44"] = "D", ["=45"] = "E", ["=46"] = "F", ["=47"] = "G", ["=48"] = "H",
    ["=49"] = "I", ["=4a"] = "J", ["=4b"] = "K", ["=4c"] = "L", ["=4d"] = "M",
    ["=4e"] = "N", ["=4f"] = "O", ["=50"] = "P", ["=51"] = "Q", ["=52"] = "R",
    ["=53"] = "S", ["=54"] = "T", ["=55"] = "U", ["=56"] = "V", ["=57"] = "W",
    ["=58"] = "X", ["=59"] = "Y", ["=5a"] = "Z", ["=5b"] = "[", ["=5c"] = "\\",
    ["=5d"] = "]", ["=5e"] = "^", ["=5f"] = "_", ["=60"] = "`", ["=61"] = "a",
    ["=62"] = "b", ["=63"] = "c", ["=64"] = "d", ["=65"] = "e", ["=66"] = "f",
    ["=67"] = "g", ["=68"] = "h", ["=69"] = "i", ["=6a"] = "j", ["=6b"] = "k",
    ["=6c"] = "l", ["=6d"] = "m", ["=6e"] = "n", ["=6f"] = "o", ["=70"] = "p",
    ["=71"] = "q", ["=72"] = "r", ["=73"] = "s", ["=74"] = "t", ["=75"] = "u",
    ["=76"] = "v", ["=77"] = "w", ["=78"] = "x", ["=79"] = "y", ["=7a"] = "z",
    ["=7b"] = "{", ["=7c"] = "|", ["=7d"] = "}", ["=7e"] = "~",
    ["=C2=A1"] = "¡", ["=C2=A2"] = "¢", ["=C2=A3"] = "£", ["=C2=A4"] = "¤",
    ["=C2=A5"] = "¥", ["=C2=A6"] = "¦", ["=C2=A7"] = "§", ["=C2=A8"] = "¨",
    ["=C2=A9"] = "©", ["=C2=AA"] = "ª", ["=C2=AB"] = "«", ["=C2=AC"] = "¬",
    ["=C2=AE"] = "®", ["=C2=AF"] = "¯", ["=C2=B0"] = "°", ["=C2=B1"] = "±",
    ["=C2=B2"] = "²", ["=C2=B3"] = "³", ["=C2=B4"] = "´", ["=C2=B5"] = "µ",
    ["=C2=B6"] = "¶", ["=C2=B7"] = "·", ["=C2=B8"] = "¸", ["=C2=B9"] = "¹",
    ["=C2=BA"] = "º", ["=C2=BB"] = "»", ["=C2=BC"] = "¼", ["=C2=BD"] = "½",
    ["=C2=BE"] = "¾", ["=C2=BF"] = "¿", ["=C3=80"] = "À", ["=C3=81"] = "Á",
    ["=C3=82"] = "Â", ["=C3=83"] = "Ã", ["=C3=84"] = "Ä", ["=C3=85"] = "Å",
    ["=C3=86"] = "Æ", ["=C3=87"] = "Ç", ["=C3=88"] = "È", ["=C3=89"] = "É",
    ["=C3=8A"] = "Ê", ["=C3=8B"] = "Ë", ["=C3=8C"] = "Ì", ["=C3=8D"] = "Í",
    ["=C3=8E"] = "Î", ["=C3=8F"] = "Ï", ["=C3=90"] = "Ð", ["=C3=91"] = "Ñ",
    ["=C3=92"] = "Ò", ["=C3=93"] = "Ó", ["=C3=94"] = "Ô", ["=C3=95"] = "Õ",
    ["=C3=96"] = "Ö", ["=C3=97"] = "×", ["=C3=98"] = "Ø", ["=C3=99"] = "Ù",
    ["=C3=9A"] = "Ú", ["=C3=9B"] = "Û", ["=C3=9C"] = "Ü", ["=C3=9D"] = "Ý",
    ["=C3=9E"] = "Þ", ["=C3=9F"] = "ß", ["=C3=A0"] = "à", ["=C3=A1"] = "á",
    ["=C3=A2"] = "â", ["=C3=A3"] = "ã", ["=C3=A4"] = "ä", ["=C3=A5"] = "å",
    ["=C3=A6"] = "æ", ["=C3=A7"] = "ç", ["=C3=A8"] = "è", ["=C3=A9"] = "é",
    ["=C3=AA"] = "ê", ["=C3=AB"] = "ë", ["=C3=AC"] = "ì", ["=C3=AD"] = "í",
    ["=C3=AE"] = "î", ["=C3=AF"] = "ï", ["=C3=B0"] = "ð", ["=C3=B1"] = "ñ",
    ["=C3=B2"] = "ò", ["=C3=B3"] = "ó", ["=C3=B4"] = "ô", ["=C3=B5"] = "õ",
    ["=C3=B6"] = "ö", ["=C3=B7"] = "÷", ["=C3=B8"] = "ø", ["=C3=B9"] = "ù",
    ["=C3=BA"] = "ú", ["=C3=BB"] = "û", ["=C3=BC"] = "ü", ["=C3=BD"] = "ý",
    ["=C3=BE"] = "þ", ["=C3=BF"] = "ÿ"
}

local iso8859_1tbl = {
    ["=20"] = " ", ["=21"] = "!", ["=22"] = '"', ["=23"] = "#", ["=24"] = "$",
    ["=25"] = "%", ["=26"] = "&", ["=27"] = "'", ["=28"] = "(", ["=29"] = ")", 
    ["=2A"] = "*", ["=2B"] = "+", ["=2C"] = ",", ["=2D"] = "-", ["=2E"] = ".", 
    ["=2F"] = "/", ["=30"] = "0", ["=31"] = "1", ["=32"] = "2", ["=33"] = "3", 
    ["=34"] = "4", ["=35"] = "5", ["=36"] = "6", ["=37"] = "7", ["=38"] = "8", 
    ["=39"] = "9", ["=3A"] = ":", ["=3B"] = ";", ["=3C"] = "<", ["=3D"] = "=", 
    ["=3E"] = ">", ["=3F"] = "?", ["=40"] = "@", ["=41"] = "A", ["=42"] = "B", 
    ["=43"] = "C", ["=44"] = "D", ["=45"] = "E", ["=46"] = "F", ["=47"] = "G",
    ["=48"] = "H", ["=49"] = "I", ["=4A"] = "J", ["=4B"] = "K", ["=4C"] = "L",
    ["=4D"] = "M", ["=4E"] = "N", ["=4F"] = "O", ["=50"] = "P", ["=51"] = "Q",
    ["=52"] = "R", ["=53"] = "S", ["=54"] = "T", ["=55"] = "U", ["=56"] = "V",
    ["=57"] = "W", ["=58"] = "X", ["=59"] = "Y", ["=5A"] = "Z", ["=5B"] = "[",
    ["=5C"] = "\\",["=5D"] = "]", ["=5E"] = "^", ["=5F"] = "_", ["=60"] = "`", 
    ["=61"] = "a", ["=62"] = "b", ["=63"] = "c", ["=64"] = "d", ["=65"] = "e",
    ["=66"] = "f", ["=67"] = "g", ["=68"] = "h", ["=69"] = "i", ["=6A"] = "j",
    ["=6B"] = "k", ["=6C"] = "l", ["=6D"] = "m", ["=6E"] = "n", ["=6F"] = "o",
    ["=70"] = "p", ["=71"] = "q", ["=72"] = "r", ["=73"] = "s", ["=74"] = "t",
    ["=75"] = "u", ["=76"] = "v", ["=77"] = "w", ["=78"] = "x", ["=79"] = "y",
    ["=7A"] = "z", ["=7B"] = "{", ["=7C"] = "|", ["=7D"] = "}", ["=7E"] = "~",
    ["=A1"] = "¡", ["=A2"] = "¢", ["=A3"] = "£", ["=A4"] = "¤", ["=A5"] = "¥",
    ["=A6"] = "¦", ["=A7"] = "§", ["=A8"] = "¨", ["=A9"] = "©", ["=AA"] = "ª",
    ["=AB"] = "«", ["=AC"] = "¬", ["=AD"] = "SHY",["=AE"] = "®", ["=AF"] = "¯",
    ["=B0"] = "°", ["=B1"] = "±", ["=B2"] = "²", ["=B3"] = "³", ["=B4"] = "´",
    ["=B5"] = "µ", ["=B6"] = "¶", ["=B7"] = "·", ["=B8"] = "¸", ["=B9"] = "¹",
    ["=BA"] = "º", ["=BB"] = "»", ["=BC"] = "¼", ["=BD"] = "½", ["=BE"] = "¾",
    ["=BF"] = "¿", ["=C0"] = "À", ["=C1"] = "Á", ["=C2"] = "Â", ["=C3"] = "Ã",
    ["=C4"] = "Ä", ["=C5"] = "Å", ["=C6"] = "Æ", ["=C7"] = "Ç", ["=C8"] = "È",
    ["=C9"] = "É", ["=CA"] = "Ê", ["=CB"] = "Ë", ["=CC"] = "Ì", ["=CD"] = "Í",
    ["=CE"] = "Î", ["=CF"] = "Ï", ["=D0"] = "Ð", ["=D1"] = "Ñ", ["=D2"] = "Ò",
    ["=D3"] = "Ó", ["=D4"] = "Ô", ["=D5"] = "Õ", ["=D6"] = "Ö", ["=D7"] = "×",
    ["=D8"] = "Ø", ["=D9"] = "Ù", ["=DA"] = "Ú", ["=DB"] = "Û", ["=DC"] = "Ü",
    ["=DD"] = "Ý", ["=DE"] = "Þ", ["=DF"] = "ß", ["=E0"] = "à", ["=E1"] = "á",
    ["=E2"] = "â", ["=E3"] = "ã", ["=E4"] = "ä", ["=E5"] = "å", ["=E6"] = "æ",
    ["=E7"] = "ç", ["=E8"] = "è", ["=E9"] = "é", ["=EA"] = "ê", ["=EB"] = "ë",
    ["=EC"] = "ì", ["=ED"] = "í", ["=EE"] = "î", ["=EF"] = "ï", ["=F0"] = "ð", 
    ["=F1"] = "ñ", ["=F2"] = "ò", ["=F3"] = "ó", ["=F4"] = "ô", ["=F5"] = "õ",
    ["=F6"] = "ö", ["=F7"] = "÷", ["=F8"] = "ø", ["=F9"] = "ù", ["=FA"] = "ú",
    ["=FB"] = "û", ["=FC"] = "ü", ["=FD"] = "ý", ["=FE"] = "þ", ["=FF"] = "ÿ"
}

if mail:find("[uU][tT][fF]%-8") then
    for k,v in pairs(utf8tbl) do
        mail = mail:gsub(k,v)
    end
elseif mail:find("[iI][sS][oO]%-8859%-1") then
    for k,v in pairs(iso8859_1tbl) do
        mail = mail:gsub(k,v)
    end
end
print(mail)

